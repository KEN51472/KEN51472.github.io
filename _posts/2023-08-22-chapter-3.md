---
layout: detail
type : 4
keyword : UNIX环境高级编程
title: UNIX环境高级编程 ：Chapter 3
description: 
---

## CHAPTER 3

## dup

dup函数会复制文件描述符，并返回一个新的文件描述符。新的文件描述符是当前可用的最小的文件描述符，与原始文件描述符共享同一个文件表项。  
dup2函数也会复制文件描述符，但是可以指定新的文件描述符的值。如果新的文件描述符已经打开，则会先关闭它。新的文件描述符与原始文件描述符共享同一个文件表项。

## sync、fsync和fdatasync

sync、fsync和fdatasync是用于文件同步的系统调用：

sync：

假设有两个文件：file1.txt和file2.txt，分别对应两个文件描述符fd1和fd2。在程序中，对这两个文件进行了写操作，将数据写入了文件缓冲区。然后，调用sync函数进行同步操作。

当调用sync函数时，操作系统会将file1.txt和file2.txt的文件缓冲区中的数据和元数据写入磁盘上的对应位置。具体的写入位置和方式由文件系统驱动程序决定，它会根据文件系统的结构和算法，将数据和元数据写入磁盘的相应位置。

这样，即使系统发生异常或断电，file1.txt和file2.txt的数据和元数据也能够恢复到最新的状态，不会丢失或损坏。通过调用sync函数，可以确保所有修改过的文件缓冲区中的数据和元数据都被写入磁盘，实现数据的持久化存储

fsync：

fsync函数用于将指定文件的数据和元数据同步到磁盘。
它会将文件缓冲区中的数据写入到对应的磁盘块中，并等待数据完全写入磁盘后才返回。
fsync函数只同步指定文件的数据和元数据，而不会同步其他文件系统的数据。

fdatasync：

fdatasync函数用于将指定文件的数据同步到磁盘，但不同步元数据。
它会将文件缓冲区中的数据写入到对应的磁盘块中，并等待数据完全写入磁盘后才返回。
fdatasync函数只同步指定文件的数据，而不同步元数据。

总结：

sync函数是一个全局的同步操作，会同步所有文件系统的数据和元数据，可能会导致系统性能下降。
fsync函数用于同步指定文件的数据和元数据。
fdatasync函数用于同步指定文件的数据，但不同步元数据。
在需要确保数据持久化存储的时候，可以使用fsync或fdatasync函数，而不是sync函数，以避免不必要的性能损失。

