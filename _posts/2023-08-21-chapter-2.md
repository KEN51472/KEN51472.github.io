---
layout: detail
type : 4
keyword : UNIX环境高级编程
title: UNIX环境高级编程 ：Chapter 2
description: 
---

## CHAPTER 2

## lseek

lseek() 是一个系统调用，用于设置文件的偏移量。文件的偏移量指示了下一次读取或写入文件时的位置。lseek() 函数的原型如下：

`off_t lseek(int fd, off_t offset, int whence);`

其中，fd 是文件描述符，offset 是偏移量，whence 是指定偏移量相对于哪个位置的参数。whence 可以取以下三个值：

SEEK_SET：相对于文件的开头位置进行偏移。
SEEK_CUR：相对于文件的当前位置进行偏移。
SEEK_END：相对于文件的末尾位置进行偏移。

每次调用 read() 函数时，会从当前偏移量所指示的位置开始读取数据，并将偏移量自动更新为读取的字节数  
连续多次调用 read() 函数会自动保持上一次读取结束后的偏移状态  
lseek() 函数与32位和64位系统之间的关系主要涉及到参数类型的大小和返回值的类型(off_t类型不同)

## IO

read() 函数的第一个参数是文件描述符fd，用于指定要读取的文件或设备。文件描述符是一个非负整数，用于唯一标识打开的文件或设备。

常见的文件描述符包括：

0：标准输入（stdin）
1：标准输出（stdout）
2：标准错误输出（stderr）
其他整数值：打开的文件或设备的文件描述符

关于/dev/null:  

在Unix系统中，/dev/null 是一个特殊的设备文件，用于丢弃写入它的数据，并且读取它将会立即返回EOF。Unix系统中经常被用于丢弃不需要的输出或不关心的数据。当将数据写入文件描述符为0的位置（即标准输入），实际上是将数据写入到 /dev/null 中，实现了数据的丢弃。

例如在脚本中不希望从标准输入读取任何数据时，可以将标准输入重定向到 /dev/null

## 文件共享

V-node（虚拟节点）：

V-node 是内核数据结构，用于表示文件系统中的一个文件或目录。  
它包含了文件的元数据信息，如文件类型、权限、大小、创建时间等。  
V-node 还包含了指向 i-node 的指针。    

I-node（索引节点）：  

I-node 是内核数据结构，用于表示文件系统中的一个文件或目录。  
它包含了文件的详细元数据信息，如文件的所有者、访问时间、修改时间、链接计数等。  
I-node 还包含了指向文件数据块的指针，这些数据块存储了文件的实际内容。  

进程文件共享：

当多个进程打开同一个文件时，它们可以共享同一个 v-node 和 i-node。  
这意味着它们可以共享文件的元数据信息和指向文件数据块的指针。  
这种共享可以节省系统资源，避免多个进程重复地加载同一个文件的元数据和数据。  

假设有两个进程 A 和 B，它们都打开了同一个文件 file.txt。当进程 A 打开文件时，内核为该文件创建一个虚拟节点 V1，并返回一个文件描述符给进程 A。虚拟节点 V1 包含了文件的元数据信息，并指向索引节点 I1。

当进程 B 打开同一个文件时，内核不需要再创建一个新的虚拟节点，而是直接返回虚拟节点 V1 给进程 B。这样，进程 A 和进程 B 共享同一个虚拟节点 V1 和索引节点 I1。

当进程 A 读取文件时，内核使用索引节点 I1 中的指针来定位文件的数据块，并读取相应的数据。同样，当进程 B 读取文件时，它也可以使用相同的索引节点 I1 来定位文件的数据块。

通过共享虚拟节点和索引节点，进程 A 和进程 B 可以共享文件的元数据信息和数据块，从而节省了系统资源。这种共享对于大型文件和多个进程同时访问文件的情况尤为重要。

## 原子操作  

原子操作指的是多步组合成一个操作，如果该操作原子的执行，要么执行完所有步骤，要么一步也不执行  
调用pread相当于调用lseek后调用read，调用pread时无法中断其定位和操作，且不更新当前文件偏移量